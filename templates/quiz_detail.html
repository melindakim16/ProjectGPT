<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>ProjectGPT – Interactive Quiz</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <link rel="icon" href="../static/favicon.png" type="image/x-icon">
  <link rel="apple-touch-icon" href="../static/apple-touch-icon.png">

  <style>
    body { font-family: 'Inter', sans-serif; background: linear-gradient(to right, #f9fbfd, #eef1f5); padding-top: 100px; }
    h2 { font-weight: 600; color: #1f2d3d; }
    .question-block { padding: 1.5rem; margin-bottom: 2rem; background: white; border-radius: 1rem; box-shadow: 0 8px 20px rgba(0,0,0,0.05); }
    .answer-option { display:block; width:100%; border:2px solid transparent; border-radius:.75rem; padding:1rem; margin-bottom:.75rem; background:#f1f4f8; color:#1f2d3d; font-weight:500; cursor:pointer; text-align:left; transition:all .2s; }
    .form-check-input { display:none; }
    .form-check-input:checked + .answer-option { border-color:#6f42c1; background-color:#e9dfff; }
    .answer-option:hover { background-color:#e9f2ff; }
    .result-section { display:none; margin-top:1rem; border-top:1px solid #dee2e6; padding-top:1rem; }
    .correct { background:#e6f4ea; border-left:5px solid #28a745; padding:.75rem 1rem; border-radius:.5rem; margin-bottom:.5rem; }
    .incorrect { background:#fdeeee; border-left:5px solid #dc3545; padding:.75rem 1rem; border-radius:.5rem; margin-bottom:.5rem; }
    .btn-gradient { background:linear-gradient(to right,#6f42c1,#007bff); color:#fff; font-weight:600; border:none; border-radius:.5rem; padding:.75rem 1.25rem; transition:background .3s, transform .2s; box-shadow:0 4px 12px rgba(0,123,255,.25); }
    .btn-gradient:hover { background:linear-gradient(to right,#5a32a3,#0056b3); transform:translateY(-2px); }
    .btn-gradient:active { transform:translateY(0); }
    .btn-secondary { background-color:#adb5bd; color:#fff; font-weight:600; border:none; border-radius:.5rem; }
    #finalScore { display:none; margin-top:2rem; padding:1.5rem; border-radius:.75rem; background-color:#e0edff; color:#004085; font-size:1.25rem; font-weight:600; text-align:center; box-shadow:0 6px 20px rgba(0,0,0,.05); }
    #saveStatus { display:none; }
  </style>
</head>
<body>

{% include 'nav.html' %}

<div class="container mb-5">
  <h2 class="mb-4 text-center">Take the Quiz</h2>

  <!-- optional save status -->
  <div id="saveStatus" class="alert alert-info text-center fw-semibold" role="alert"></div>

  <form method="POST" id="quizForm" data-story-id="{{ story_id }}">
    {% for i in range(10) %}
    <div class="question-block">
      <h5 class="mb-3"><strong>Q{{ i+1 }}.</strong> {{ question[i] }}</h5>

      {% for key, val in options[i].items() %}
      <label class="form-check-label w-100">
        <input
          class="form-check-input"
          type="radio"
          name="q{{ i }}"
          value="{{ key }}"
          {% if selected and selected[i] == key %}checked{% endif %}
          required
        >
        <div class="answer-option">
          <strong>{{ key }}.</strong> {{ val }}
        </div>
      </label>
      {% endfor %}

      <div class="result-section" id="result_{{ i }}" {% if selected and selected[i] %}style="display:block"{% endif %}>
        {% for key, val in options[i].items() %}
          {% if key == correct[i] %}
            <div class="correct"><i class="bi bi-check-circle"></i> <strong>{{ key }}:</strong> {{ val }} <span class="text-success">(Correct Answer)</span></div>
          {% else %}
            <div class="incorrect"><i class="bi bi-x-circle"></i> <strong>{{ key }}:</strong> {{ val }}</div>
          {% endif %}
        {% endfor %}
      </div>
    </div>
    {% endfor %}

    <div class="mt-4 d-flex flex-column flex-sm-row gap-3">
      <button type="submit" class="btn btn-gradient w-100">Submit Quiz</button>
      <button type="button" class="btn btn-secondary w-100" onclick="location.reload()">Retry</button>
    </div>
  </form>

  <div id="finalScore"></div>
</div>

<script>
  const formEl = document.getElementById("quizForm");
  const finalScoreDiv = document.getElementById("finalScore");
  const saveStatus = document.getElementById("saveStatus");

  formEl.addEventListener("submit", async function(event) {
    event.preventDefault();

    let score = 0;
    const answers = []; // collect for server
    const total = 10;   // your quiz size

    // 1) Grade on the client and collect answers
    {% for i in range(10) %}
    (function() {
      const selected = document.querySelector('input[name="q{{ i }}"]:checked');
      const correct = "{{ correct[i] }}";
      const ans = selected ? selected.value : null;
      answers.push(ans);              // push "A"/"B"/"C"/"D" or null
      if (ans && ans === correct) { score += 1; }
      document.getElementById("result_{{ i }}").style.display = "block";
    })();
    {% endfor %}

    // 2) Display client-side score immediately
    finalScoreDiv.textContent = `You scored ${score} out of ${total}!`;
    finalScoreDiv.style.display = "block";
    finalScoreDiv.scrollIntoView({ behavior: 'smooth' });

    // 3) Save to server (overwrites previous submission → supports resubmit)
    const storyId = formEl.getAttribute("data-story-id");
    saveStatus.className = "alert alert-info text-center fw-semibold";
    saveStatus.textContent = "Saving your results…";
    saveStatus.style.display = "block";

    try {
      const res = await fetch(`/api/quiz_submit/${storyId}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ answers })
      });

      const data = await res.json();
      if (!res.ok || !data.ok) {
        throw new Error(data.error || "Save failed");
      }

      // 4) Confirm saved (and show server-validated score if needed)
      saveStatus.className = "alert alert-success text-center fw-semibold";
      saveStatus.textContent = `Saved! Server recorded ${data.correct}/${data.total} correct.`;
    } catch (err) {
      console.error(err);
      saveStatus.className = "alert alert-danger text-center fw-semibold";
      saveStatus.textContent = "Could not save results. Please try again.";
    }
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
